//http://www.danstools.com/javascript-beautify/

if (!String.prototype.trim) {
    String.prototype.trim = function() {
        return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, "")
    }
}
if (!String.prototype.includes) {
    String.prototype.includes = function(search, start) {
        "use strict";
        if (typeof start !== "number") {
            start = 0
        }
        if (start + search.length > this.length) {
            return false
        } else {
            return this.indexOf(search, start) !== -1
        }
    }
}
if (!Array.prototype.includes) {
    Array.prototype.includes = function(searchElement) {
        "use strict";
        if (this === null) {
            throw new TypeError("Array.prototype.includes called on null or undefined")
        }
        var O = Object(this);
        var len = parseInt(O.length, 10) || 0;
        if (len === 0) {
            return false
        }
        var n = parseInt(arguments[1], 10) || 0;
        var k;
        if (n >= 0) {
            k = n
        } else {
            k = len + n;
            if (k < 0) {
                k = 0
            }
        }
        var currentElement;
        while (k < len) {
            currentElement = O[k];
            if (searchElement === currentElement || searchElement !== searchElement && currentElement !== currentElement) {
                return true
            }
            k++
        }
        return false
    }
}
if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function(searchElement, fromIndex) {
        var k;
        if (this === null) {
            throw new TypeError('"this" is null or not defined')
        }
        var o = Object(this);
        var len = o.length >>> 0;
        if (len === 0) {
            return -1
        }
        var n = +fromIndex || 0;
        if (Math.abs(n) === Infinity) {
            n = 0
        }
        if (n >= len) {
            return -1
        }
        k = Math.max(n >= 0 ? n : len - Math.abs(n), 0);
        while (k < len) {
            if (k in o && o[k] === searchElement) {
                return k
            }
            k++
        }
        return -1
    }
}
if (!Array.prototype.filter) {
    Array.prototype.filter = function(fun) {
        "use strict";
        if (this === void 0 || this === null) {
            throw new TypeError
        }
        var t = Object(this);
        var len = t.length >>> 0;
        if (typeof fun !== "function") {
            throw new TypeError
        }
        var res = [];
        var thisArg = arguments.length >= 2 ? arguments[1] : void 0;
        for (var i = 0; i < len; i++) {
            if (i in t) {
                var val = t[i];
                if (fun.call(thisArg, val, i, t)) {
                    res.push(val)
                }
            }
        }
        return res
    }
}
Array.prototype.diff = function(a) {
    return this.filter(function(i) {
        return a.indexOf(i) < 0
    })
};

function login() {
    var ref = document.getElementsByName("ref")[0];
    ref.setAttribute("value", ref.getAttribute("value") + location.hash);
    var helpClick = false;
    var helpLink = document.getElementById("helpLink");
    helpLink.onmousedown = function(e) {
        helpClick = true
    };
    var login = document.getElementById("login");
    login.onblur = function(e) {
        if (helpClick) {
            helpClick = false
        } else {
            if (!login.value) {
                document.getElementById("input-login").classList.add("has-error");
                document.getElementById("helpBlock-login").classList.remove("hidden")
            } else {
                document.getElementById("input-login").classList.remove("has-error");
                document.getElementById("helpBlock-login").classList.add("hidden")
            }
        }
    };
    var password = document.getElementById("password");
    password.onblur = function(e) {
        if (helpClick) {
            helpClick = false
        } else {
            if (!password.value) {
                document.getElementById("input-password").classList.add("has-error");
                document.getElementById("helpBlock-password").classList.remove("hidden")
            } else {
                document.getElementById("input-password").classList.remove("has-error");
                document.getElementById("helpBlock-password").classList.add("hidden")
            }
        }
    };
    document.getElementById("factors").onsubmit = function() {
        login.value = login.value.trim()
    };
    var loginSubmit = document.getElementById("loginSubmit");
    loginSubmit.onclick = function() {
        loginSubmit.classList.remove("btn-blue");
        loginSubmit.innerHTML = "<i id='loginSpinner' class='icon icon-spinner icon-lg animate-pulse'></i>&nbspLogging In"
    }
}

function login_error() {
    var content = document.getElementById("content");
    var errModal = '<div class="alert alert-danger well-sm" role="alert">' + '<p><span class="icon icon-lg icon-attention-circled" aria-hidden="true"></span> ' + error + "</p>" + "</div>";
    var pwxModal = '<div id="alertPwx" class="alert" role="alert">' + '<p class="lead"><strong>Please change your password.</strong></p>' + '<p id="msgPwx"></p>' + "<hr>" + '<p><a href="http://www.itcs.umich.edu/identity/pwexpiry.php" target="_blank"><small><span id="errPwx"></span></small></a></p>' + "</div>" + '<div class="text-right">' + '<a id="goPwx" class="btn" href="' + pw_change_url + '" role="button">Change Password</a>&nbsp;' + '<a id="noPwx" class="btn btn-blue" href="#" role="button">Continue to site</a>' + "</div>";
    var twofaModal = '<iframe id="duo_iframe" frameborder="0"></iframe>' + "</iframe>" + '<form action="/cosign-bin/cosign.cgi" method="post" id="duo_form">' + '<input type="hidden" name="ref" value="' + ref + '" />' + '<input type="hidden" name="service" value="' + service + '" />' + '<input type="hidden" name="required" value="' + requireFactors + '" />' + "</form>";
    var twofaFriendModal = '<div class="alert alert-danger" role="alert">' + '<p class="lead"><strong>Access denied.</strong></p>' + "<hr>" + "<p>You do not have access to this system.</p>" + "</div>";
    var twofaExemptModal = '<div class="alert alert-warning" role="alert">' + '<p class="lead"><strong>Continue without two-factor?</strong></p>' + "<p>You are currently exempt from using two-factor authentication for this service.</p>" + "<p>You may enroll in two-factor authentication if you wish." + "You will then need to use it every time you log in to this service.</p>" + "<p>Or you can continue to log in without using it.</p>" + "<hr>" + '<p><small><a href="http://its.umich.edu/two-factor-authentication">Learn about two-factor</a></small></p>' + "</div>" + '<div class="text-right">' + '<a id="go2fa" class="btn btn-default" href="#" role="button">Enroll in Two-Factor</a>&nbsp;' + '<a id="no2fa" class="btn btn-blue" href="#" role="button">Continue to Site</a>' + "</div>";
    try {
        pwx = JSON.parse(pw_expiry_check.replace(/&quot;/g, '"'))
    } catch (e) {}
    if (completeFactors) {
        completeFactors = completeFactors.split(",");
        requireFactors = requireFactors.split(",");
        var factors = document.getElementById("factors");
        var title = document.getElementById("title");
        var grid = document.getElementById("grid");
        var unsatisfiedFactors = requireFactors.diff(completeFactors);
        title.innerHTML = "";
        content.style.display = "block";
        factors.style.display = "none";
        factors.innerHTML += '<input type="hidden" name="pwx_payload" id="pwx_payload" value="" />';
        factors.innerHTML += '<input name="noToken" id="noToken" type="checkbox" value="1" style="display:none;"/>';
        document.getElementById("login").disabled = true;
        document.getElementById("password").disabled = true;
        if (unsatisfiedFactors.includes("mtoken") || unsatisfiedFactors.includes("two-factor")) {
            if (completeFactors.includes("friend")) {
                content.innerHTML = twofaFriendModal
            } else if (twofa_exempt == "true") {
                content.innerHTML = twofaExemptModal;
                document.getElementById("no2fa").onclick = function() {
                    document.getElementById("noToken").checked = true;
                    factors.submit()
                };
                document.getElementById("go2fa").onclick = function() {
                    title.innerHTML = "Two-Factor Enrollment";
                    grid.classList.add("col-md-8", "col-md-offset-2");
                    grid.classList.remove("col-md-6", "col-md-offset-3");
                    content.innerHTML = twofaModal;
                    Duo.init(duo_config)
                }
            } else {
                title.innerHTML = "Two-Factor Authentication Required";
                grid.classList.add("col-md-8", "col-md-offset-2");
                grid.classList.remove("col-md-6", "col-md-offset-3");
                content.innerHTML = twofaModal;
                Duo.init(duo_config)
            }
        } else if (unsatisfiedFactors.includes("pw_expiry") && pwx !== null) {
            content.innerHTML = pwxModal;
            var noPwx = document.getElementById("noPwx");
            var goPwx = document.getElementById("goPwx");
            var errPwx = document.getElementById("errPwx");
            var msgPwx = document.getElementById("msgPwx");
            var alertPwx = document.getElementById("alertPwx");
            noPwx.onclick = function() {
                factors.submit()
            };
            document.factors.pwx_payload.value = JSON.stringify(pwx);
            if (pwx.expiryResponse.person.expired) {
                errPwx.innerHTML = "Why did my password expire?";
                msgPwx.innerHTML = "Your UMICH (Level-1) password has expired." + "<br/>Change your password to reactivate it.";
                alertPwx.classList.add("alert-danger");
                noPwx.style.display = "none";
                goPwx.classList.add("btn-danger")
            } else if (pwx.expiryResponse.person.warning) {
                errPwx.innerHTML = "Why is my password expiring?";
                alertPwx.classList.add("alert-warning");
                goPwx.classList.add("btn-default");
                if (pwx.expiryResponse.person.remaining !== null) {
                    if (pwx.expiryResponse.person.remaining == 1) {
                        msgDay = " expires tomorrow."
                    } else {
                        msgDay = " will expire in " + pwx.expiryResponse.person.remaining + " days."
                    }
                    msgPwx.innerHTML = "<p>Your UMICH (Level-1) password" + msgDay
                }
            } else {
                content.innerHTML = '<div id="content" class="alert alert-danger" role="alert">' + '<p class="lead"><strong>Unknown password error.</strong></p>' + '<p>Please try again or contact the <a href="http://its.umich.edu/help/">ITS Service Center</a> if you need assistance.</p>' + "</div>"
            }
        } else {
            content.innerHTML = '<div id="content" class="alert alert-danger" role="alert">' + '<p class="lead"><strong>Unknown factor error.</strong></p>' + '<p>Please try again or contact the <a href="http://its.umich.edu/help/">ITS Service Center</a> if you need assistance.</p>' + "</div>"
        }
    } else if (error) {
        content.innerHTML = errModal
    } else {
        content.innerHTML = '<div id="content" class="alert alert-danger" role="alert">' + '<p class="lead"><strong>Unknown error.</strong></p>' + '<p>Please try again or contact the <a href="http://its.umich.edu/help/">ITS Service Center</a> if you need assistance.</p>' + "</div>"
    }
}

function reauth() {
    document.getElementById("title").innerHTML = "Please re-authenticate.";
    document.getElementById("loginSubmit").innerHTML = "Re-Authenticate";
    document.getElementById("factors").innerHTML += '<input type="hidden" name="reauth" value="true" />';
    document.getElementById("factors").innerHTML += '<input type="hidden" name="url" value="' + ref + '" />'
}(function() {
    login();
    if (view == "reauth") {
        reauth()
    } else if (view == "login_error") {
        login_error()
    } else {}
})();